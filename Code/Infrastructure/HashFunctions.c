/*JWHSSHVBSGPLHERE*/
/*
 * HashFunctions.c
 *
 * Authors: Vivek B. Sardeshmukh 
 *          James W Hegeman
 *
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include "HashFunctions.h"

unsigned int HASH_FUNC[MAX_HASH_FUNCTION][HASH_FUNCTION_WIDTH] = {
    {546,685,977,1230,1670,1805,2523,3563,3798,3891,3975,3979,4894,5637,5916,6860,6916,7090,7140,7501,7560,7626,7865,8115},
    {857,1270,1325,1509,1880,3100,3147,3177,3824,3857,4076,4296,4623,4708,4908,5158,5192,5859,7347,7467,7558,7823,8040,8158},
    {284,674,684,718,1157,1500,2196,2458,2589,3103,3282,3462,3827,4306,4545,5121,5780,6091,6249,6565,6956,7107,7810,8023},
    {95,625,626,852,1158,1237,1503,2433,2819,3168,3421,3584,3727,4273,4308,4379,4753,4815,5579,5940,7069,7292,7660,7859},
    {35,835,1493,1697,1972,2118,2264,3083,3548,3926,3930,4228,4385,4905,5049,5391,5799,6173,6352,6480,7355,7431,7817,8022},
    {260,270,342,656,710,1882,2549,2596,3266,4526,4695,4914,4992,5415,5675,5790,5796,6709,6755,6758,6918,7194,7763,7955},
    {201,1049,1601,2020,2037,2609,3498,3863,4052,4584,4585,4895,5058,5140,5299,5323,6065,6691,6700,6981,7360,7396,7566,7575},
    {600,617,649,673,1159,1257,1265,2336,2880,3468,4051,4085,4135,4813,4873,5007,5463,5469,5633,5705,5782,6074,6085,7082},
    {264,1029,1161,1991,2244,2356,2476,3279,4418,4466,4481,4723,4948,5035,5081,5992,6048,6197,6384,7217,7385,7528,7572,7665},
    {70,233,1224,2345,2539,2676,3227,3476,3611,4911,5789,5954,6134,6450,6754,6859,6951,6952,7113,7184,7254,7390,7682,7988},
    {305,1165,1681,2002,2316,2500,3423,3439,3777,3978,4110,4250,4326,4501,4719,5016,6255,6922,6972,7011,7253,7281,7530,7860},
    {399,595,669,1802,2115,3301,3808,4340,4744,4965,5001,5090,5347,5394,5527,5801,5924,6093,6328,6359,6693,6827,6835,6991},
    {560,927,1541,2142,2260,3230,3460,3571,4163,4182,4550,4688,5003,5023,5530,5922,6257,6394,6512,6976,7212,7270,7348,7602},
    {589,738,1045,2161,2185,2319,2439,2594,2671,2862,3523,3567,3999,4659,6717,7020,7051,7152,7188,7673,7683,7724,8109,8116},
    {920,978,1387,2543,2635,3396,3478,3483,3778,3996,4801,4883,5466,5975,6023,6360,6533,6731,6870,6941,7240,7405,7952,8041},
    {278,1572,2780,3309,4007,4129,4140,4240,4255,4532,5141,5414,5669,6057,6333,6821,7068,7220,7285,7309,7564,7576,7710,8083},
    {78,875,1242,1396,2149,2212,2222,2440,3572,4065,4123,4226,4423,4556,6161,6174,6900,7037,7089,7284,7322,7491,7623,8002},
    {644,2859,3619,3623,3813,3872,4061,4184,4361,4634,4725,4752,5231,5756,5844,5920,6066,6495,6751,6769,6942,7772,7786,8037},
    {1009,2578,2631,2964,3443,3819,3946,4000,4685,5174,5594,5643,5791,5911,6049,6341,6967,7298,7371,7376,7412,7517,7773,7830},
    {427,924,2246,2973,3220,3223,3912,4096,4301,4455,4711,4964,5522,5536,5766,5990,6312,6357,6380,6763,7178,7273,7323,7947},
    {390,1525,2564,3215,3292,3405,3457,4048,4210,4424,4643,5071,5292,5792,6133,6744,6953,7021,7039,7193,7380,7636,7982,8094},
    {914,961,992,1218,1523,2162,2186,4117,4174,4260,4890,4978,5111,5610,6125,6147,6219,6280,7477,7627,7961,8071,8168,8183},
    {855,878,1192,1292,1616,1623,1907,2000,2667,2755,3539,3746,4166,4428,4706,5509,7065,7079,7183,7436,7523,7557,7580,7613},
    {647,1246,1379,1558,1585,1712,1956,1957,2838,2999,3082,3504,3508,3796,4264,4714,4898,4972,5092,5321,5681,5775,5874,7610},
    {883,1590,2572,3248,3851,3938,3963,4143,4315,4444,4776,4853,4931,5022,5338,6069,6236,6361,6493,6531,6818,7269,7293,7866},
    {539,1222,1579,1970,2015,2164,2256,2485,3137,3712,3953,4017,4322,4514,5601,5744,5746,5967,6189,6491,6871,7616,7770,8070},
    {752,856,2176,2470,2598,2805,2977,4097,4133,4426,4694,4841,5152,5290,5546,5797,5798,6322,6339,6543,6825,6874,7490,7685},
    {103,586,726,967,1302,2333,2451,2496,2542,3112,3172,3765,3937,4179,4400,4698,5869,5910,6036,6252,6346,6561,7980,7983},
    {393,843,915,1026,2206,2344,2776,2845,2988,3092,3409,4491,4704,4748,4762,5339,5346,5375,5620,5692,5906,6616,6719,6790},
    {292,902,983,1176,1181,1995,2654,3181,3442,3718,3759,3914,4386,4751,4932,5161,5399,5814,6290,6398,6496,6625,7447,7843},
    {92,192,1285,1556,1718,2913,3794,3879,3976,4142,4461,4502,4525,4749,4977,5543,5706,5757,6117,6536,7126,7386,7555,8029},
    {431,711,908,1516,1674,1871,2032,2153,2436,2582,3955,4005,4098,4427,4625,5755,6076,6226,6682,6797,7382,7958,7970,8189},
};

/*
 * @func cmpfn()
 * comparator function for qsort
 */
int cmpfn(const void *a, const void *b) 
{ 
    const unsigned int *ia = (const unsigned int *)a; // casting pointer types 
    const unsigned int *ib = (const unsigned int *)b;
    return *ia  - *ib; 
}

unsigned int getRandomIndex(unsigned int min, unsigned int max){
    unsigned int r;
    const unsigned int range = max - min;
    const unsigned int buckets = RAND_MAX / range;
    const unsigned int limit = buckets * range;
    do
    {
	r = random();
    } while (r >= limit);

    return min + (r / buckets);
}

void HashFunctionsInit(unsigned int seed){
    unsigned int i, j;
    srandom(seed);
    for(i = 0; i < MAX_HASH_FUNCTION; i++){
	for(j = 0; j < HASH_FUNCTION_WIDTH; j++){
	    HASH_FUNC[i][j] = getRandomIndex(32, RECORD_SIZE);
	}
	qsort(HASH_FUNC[i], HASH_FUNCTION_WIDTH, sizeof(unsigned int), cmpfn);
    }
}

unsigned int HashValue(void *record, unsigned int functionNumber){
    unsigned int hashValue;
    unsigned int i;
    unsigned int bindex; 
    unsigned int windex;
    unsigned int index;
    void *whereisThisBit;
    hashValue = 0;
    for(i = 0; i < HASH_FUNCTION_WIDTH; i++){
	bindex = HASH_FUNC[functionNumber][i];
	windex = bindex / 32; 
	index = bindex % 32; 
	whereisThisBit = record + windex*4;
	if(*(unsigned int*)whereisThisBit & (1 << index)){
	    hashValue |= 1 << i;
	    if(DEBUG > 1){
		fprintf(stderr, "%d is set\n", i); 
	    }
	}
    }
    return hashValue;
}


