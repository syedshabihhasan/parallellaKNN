/*
 * Author:  Vivek B. Sardeshmukh 
 *
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include "HashFunctions.h"
unsigned int HASH_FUNC[MAX_HASH_FUNCTION][HASH_FUNCTION_WIDTH] = {
    {60,299,333,1031,1073,1750,1963,2677,3286,3604,4559,4639,4772,5923,6176,6351,6611,6674,7440,7605,7608,7722,7733,8092},
    {371,706,840,887,1293,1344,1612,2293,2299,2436,2735,3085,3544,4011,4126,4971,5932,5989,6314,6367,6506,6807,6950,7258},
    {70,919,947,955,1332,1455,1897,1996,2254,2268,3140,3214,3219,3849,3993,4074,5817,5911,6439,6719,7026,7059,7361,7788},
    {541,557,1377,2838,3175,3242,3593,3724,4106,4493,4647,5858,6112,6284,6349,6696,6884,6898,7024,7245,7293,7572,7707,7785},
    {224,806,886,923,1212,1315,1710,1765,2090,2505,2541,2664,3030,3556,3738,3828,3933,4447,5007,5173,6203,6750,7699,7746},
    {85,155,530,1463,1593,1756,2071,2144,2516,2609,2665,2925,2978,3001,3035,3744,4230,4236,4343,4909,5410,6185,7341,8120},
    {152,313,1093,1349,1591,2009,2676,3073,3151,4053,4225,4284,4624,4678,4903,5645,5716,5796,5839,5959,6675,6790,7468,8130},
    {490,716,1185,1467,1551,1633,1761,2007,2484,3111,3195,3537,4490,5156,5192,5253,6013,6927,6999,7048,7169,7271,7388,7800},
    {96,453,1144,1678,2033,2070,2456,2546,2746,2905,3881,4154,4302,4634,5074,5106,5446,5909,5962,6060,6278,6710,6736,7902},
    {391,774,1886,2002,2212,2318,2744,2879,3176,3860,3901,4600,4957,5861,6419,6439,6483,6605,6728,6867,6900,7116,7288,7393},
    {183,870,1049,1271,1627,1893,1992,2374,2918,3114,3179,3318,4313,4569,5055,5127,5496,5725,6085,6323,6800,6880,6909,7821},
    {146,531,772,1369,1825,2117,2365,2368,3103,3565,4074,4693,4806,4972,5063,5605,5671,6046,6673,6902,7833,7846,7984,8138},
    {742,969,1352,1358,1673,2094,2396,2594,3427,3608,3685,3878,3931,4041,4127,4189,4709,5470,6714,6756,7036,7497,8054,8169},
    {444,722,912,1062,1107,1315,1764,2980,3165,4257,4280,4418,4458,4545,4621,4891,5418,5574,6320,6350,7076,7749,7782,7786},
    {143,307,421,566,1054,1447,1496,1633,1976,2846,3092,3215,3528,3780,3877,4187,4600,4717,5656,6332,6493,6989,7297,7463},
    {654,1570,1656,1770,2346,3149,3331,3423,3558,3957,4170,4459,4848,5353,5372,5615,6313,6897,6936,7115,7212,7335,7353,7889},
    {627,968,1406,1962,2052,2386,2571,3212,3230,3586,3666,3807,4110,4289,4524,4646,5395,5727,5901,6040,6621,6625,7727,7899},
    {171,173,505,949,1076,1300,1546,2323,2374,2615,2739,2867,3045,3230,3676,3705,4495,4584,4950,6038,6785,7123,7476,8070},
    {621,681,695,880,1014,1396,1860,2326,2806,2842,2900,2963,3041,3315,3862,4212,4910,5070,5261,6329,7201,7341,7665,7905},
    {42,889,900,1032,1489,2019,2254,3453,4301,4314,4421,4580,5229,6702,7006,7169,7221,7231,7269,7292,7747,7968,7988,8187},
    {151,492,760,1609,2244,2355,4006,4009,5029,5110,5499,5722,5856,5861,5968,5994,6081,6525,6783,7291,7351,7442,8015,8190},
    {226,312,444,1720,2110,2116,2287,2661,3116,3127,3389,3411,3806,5039,5270,5353,5903,5999,6019,6106,6142,6493,7362,7823},
    {215,286,424,792,1186,1188,1621,2003,2108,3991,4071,4087,4201,4363,4774,5389,5746,5760,6041,6360,6442,6854,6967,7172},
    {376,1110,1532,1746,2673,2687,2719,2941,3031,3388,3572,3766,4783,4978,5150,5156,5594,5738,5802,6806,6859,7766,7935,8031},
    {568,1281,1408,1505,2051,2600,2725,2982,3684,3867,3985,4102,4146,4317,4440,4528,5068,5396,5412,5956,6130,6912,7407,8104},
    {289,310,1472,1560,1881,1914,2354,2416,2450,2743,3413,3729,4932,5041,5471,5578,5716,5985,6388,6508,6803,7367,7458,7883},
    {79,685,705,1550,1775,1874,2251,2508,2554,3757,3826,4488,4735,4979,5013,5316,6299,6541,6825,7456,7638,7699,7982,8112},
    {817,838,1160,1834,1836,2150,2681,3374,4199,4255,4541,4625,4671,5094,5117,5481,5607,5689,6342,6844,7055,7132,7970,8050},
    {71,342,551,883,1105,1191,1247,1419,2192,2296,3379,4356,4403,4694,4718,4986,5184,5272,5830,5917,5946,6406,7925,8060},
    {613,745,998,1200,1346,1685,2336,2900,3002,3102,3538,3699,3965,3974,4218,4266,4693,4697,5568,5751,6976,6998,7327,8036},
    {941,1247,1309,1366,1898,2109,2121,2580,2974,3212,4426,4825,4844,4915,5473,5615,5824,6955,6995,7039,7195,7873,7914,8163},
    {93,961,1017,1654,2170,2233,2236,2827,3233,3329,3735,4012,4200,4235,4481,4811,5310,5339,5477,6008,6536,7360,7772,8177}
};

/*
 * @func cmpfn()
 * comparator function for qsort
 */
int cmpfn(const void *a, const void *b) 
{ 
    const unsigned int *ia = (const unsigned int *)a; // casting pointer types 
    const unsigned int *ib = (const unsigned int *)b;
    return *ia  - *ib; 
}

unsigned int getRandomIndex(unsigned int min, unsigned int max){
    int r;
    const unsigned int range = max - min;
    const unsigned int buckets = RAND_MAX / range;
    const unsigned int limit = buckets * range;
    do
    {
	r = random();
    } while (r >= limit);

    return min + (r / buckets);
}

void HashFunctionsInit(unsigned int seed){
    unsigned int i, j;
    srandom(seed);
    for(i = 0; i < MAX_HASH_FUNCTION; i++){
	for(j = 0; j < HASH_FUNCTION_WIDTH; j++){
	    HASH_FUNC[i][j] = getRandomIndex(32, RECORD_SIZE);
	}
	qsort(HASH_FUNC[i], HASH_FUNCTION_WIDTH, sizeof(unsigned int), cmpfn);
    }
}

unsigned int HashValue(void *record, unsigned int functionNumber){
    unsigned int hashValue;
    int i;
    unsigned int bindex; 
    unsigned int windex;
    unsigned int index;
    hashValue = 0;
    for(i = 0; i < HASH_FUNCTION_WIDTH; i++){
	bindex = HASH_FUNC[functionNumber][i];
	windex = bindex / 32; 
	index = bindex % 32; 
	if(*(unsigned int*)(record + windex) & (1 << index)){
	    hashValue |= 1 << i;
	    if(DEBUG){
		fprintf(stderr, "%d is set\n", i); 
	    }
	}
    }
    return hashValue;
}


